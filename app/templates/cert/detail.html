{% extends "base.html" %}

{% block title %}{{ cert.subject.common_name }} - HomeLab PKI{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="row mb-3">
            <div class="col">
                <a href="/certs" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-8">
                <h1>
                    {{ cert.subject.common_name }}
                    {% if cert.source == 'external' %}
                    <span class="badge bg-warning text-dark">External</span>
                    {% endif %}
                </h1>
                {% if cert.source == 'external' %}
                <p class="text-muted">
                    <i class="bi bi-info-circle"></i> This certificate was signed externally or imported. Private key is not managed by this system.
                </p>
                {% endif %}
            </div>
            <div class="col-md-4 text-end">
                {% if not cert_config.get('revoked_at') %}
                <button class="btn btn-warning me-2" onclick="showRevokeModal()">
                    <i class="bi bi-shield-x"></i> Revoke
                </button>
                {% elif cert_config.get('revocation_reason') == 'certificateHold' %}
                <button class="btn btn-success me-2" onclick="showUnrevokeModal()">
                    <i class="bi bi-shield-check"></i> Remove Hold
                </button>
                {% endif %}
                <button class="btn btn-danger" onclick="confirmDelete()">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </div>
        </div>

<!-- Certificate Information -->
<div class="card mb-4">
    <div class="card-header">Certificate Information</div>
    <div class="card-body">
        <!-- Certificate Chain Breadcrumb -->
        {% if cert_chain %}
        <nav aria-label="Certificate Chain" class="mb-3">
            <ol class="breadcrumb mb-0">
                {% for ca in cert_chain %}
                <li class="breadcrumb-item">
                    <a href="{{ ca.url }}">
                        {% if ca.type == 'root' %}
                        <i class="bi bi-shield-lock text-primary"></i>
                        {% else %}
                        <i class="bi bi-diagram-3 text-info"></i>
                        {% endif %}
                        {{ ca.name }}
                    </a>
                </li>
                {% endfor %}
                <li class="breadcrumb-item active" aria-current="page">
                    <i class="bi bi-file-earmark-lock text-success"></i>
                    {{ cert.subject.common_name }}
                </li>
            </ol>
        </nav>
        <hr>
        {% endif %}

        <table class="table table-borderless">
            <tr>
                <th>Subject:</th>
                <td>
                    {% if cert.subject.common_name %}CN={{ cert.subject.common_name }}{% endif %}
                    {% if cert.subject.organization %}, O={{ cert.subject.organization }}{% endif %}
                    {% if cert.subject.country %}, C={{ cert.subject.country }}{% endif %}
                </td>
            </tr>
            <tr>
                <th>Subject Alternative Names:</th>
                <td>
                    {% if cert.sans %}
                        {% for san in cert.sans %}
                            <span class="badge bg-secondary">{{ san }}</span>
                        {% endfor %}
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            <tr>
                <th>Validity:</th>
                <td>
                    {{ cert.not_before.strftime('%d.%m.%Y %H:%M') }} - {{ cert.not_after.strftime('%d.%m.%Y %H:%M') }}
                    <span class="badge bg-{{ cert.validity_status }}">{{ cert.validity_text }}</span>
                </td>
            </tr>
            {% if cert_config.get('revoked_at') %}
            <tr>
                <th>Revocation Details:</th>
                <td>
                    <strong>Revoked At:</strong> {{ cert_config.revoked_at }}<br>
                    <strong>Reason:</strong> {{ cert_config.revocation_reason }}
                </td>
            </tr>
            {% endif %}
            <tr>
                <th>Serial Number:</th>
                <td><code>{{ cert.serial_number }}</code></td>
            </tr>
            <tr>
                <th>Fingerprint (SHA256):</th>
                <td><code>{{ cert.fingerprint_sha256 }}</code></td>
            </tr>
            <tr>
                <th>Key Usage:</th>
                <td>
                    {% if cert.key_usage %}
                        {% for ku in cert.key_usage %}
                            <span class="badge bg-info">{{ ku }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <th>Extended Key Usage:</th>
                <td>
                    {% if cert.extended_key_usage %}
                        {% for eku in cert.extended_key_usage %}
                            <span class="badge bg-success">{{ eku }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
            </tr>
        </table>
    </div>
</div>

<!-- Downloads -->
<div class="card mb-4">
    <div class="card-header">Downloads</div>
    <div class="card-body">
        <a href="/download/cert/{{ cert.id }}/cert" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-download"></i> Certificate (.crt)
        </a>
        {% if cert.source != 'external' %}
        <a href="/download/cert/{{ cert.id }}/key" class="btn btn-sm btn-outline-warning"
           onclick="return confirmKeyDownload(event, this.href)">
            <i class="bi bi-download"></i> Private Key (.key)
        </a>
        {% endif %}
        <a href="/download/cert/{{ cert.id }}/fullchain" class="btn btn-sm btn-outline-success">
            <i class="bi bi-download"></i> Full Chain (.pem)
        </a>
    </div>
</div>

<!-- Certificate Content -->
<div class="accordion" id="certContentAccordion">
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingOne">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCertContent" aria-expanded="false" aria-controls="collapseCertContent">
                Certificate Details
            </button>
        </h2>
        <div id="collapseCertContent" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#certContentAccordion">
            <div class="accordion-body">
                <div class="d-flex justify-content-end mb-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="copyActiveTabContent()">
                        <i class="bi bi-clipboard"></i> Copy
                    </button>
                </div>
                <ul class="nav nav-tabs" id="certTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="text-tab" data-bs-toggle="tab" data-bs-target="#text-content" type="button" role="tab">
                            Text Format
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pem-tab" data-bs-toggle="tab" data-bs-target="#pem-content" type="button" role="tab">
                            PEM Format
                        </button>
                    </li>
                </ul>
                <div class="tab-content" id="certTabContent">
                    <div class="tab-pane fade show active" id="text-content" role="tabpanel">
                        <pre id="certTextContent" class="code-block">{{ cert_text }}</pre>
                    </div>
                    <div class="tab-pane fade" id="pem-content" role="tabpanel">
                        <pre id="certPemContent" class="code-block">{{ cert_content }}</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    </div>

    <!-- Help Panel -->
    <div class="col-lg-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> Certificate Details
            </div>
            <div class="card-body">
                <p><strong>Certificate Chain</strong></p>
                <p class="text-muted small">
                    The breadcrumb at the top shows the trust chain from Root CA through any
                    Intermediate CAs to this certificate. Click on any CA to view its details.
                </p>

                <hr>

                <p><strong>Subject Alternative Names (SANs)</strong></p>
                <p class="text-muted small">
                    SANs list all hostnames and IP addresses this certificate is valid for.
                    Modern browsers require SANs for proper certificate validation.
                </p>

                <hr>

                <p><strong>Key Usage Extensions</strong></p>
                <ul class="text-muted small">
                    <li><strong>Key Usage</strong> - Basic operations (signing, encryption)</li>
                    <li><strong>Extended Key Usage</strong> - Specific purposes (TLS, code signing)</li>
                </ul>

                <hr>

                <p><strong>Downloads</strong></p>
                <ul class="text-muted small">
                    <li><strong>Certificate</strong> - Public certificate file</li>
                    {% if cert.source != 'external' %}
                    <li><strong>Private Key</strong> - Keep secure and confidential</li>
                    {% endif %}
                    <li><strong>Full Chain</strong> - Certificate + all CA certs in chain</li>
                </ul>

                <hr>

                <p><strong>Certificate Revocation</strong></p>
                <p class="text-muted small">
                    Revoked certificates are added to the CA's CRL (Certificate Revocation List)
                    per RFC 5280. Clients can check the CRL to verify certificate validity.
                </p>
                <ul class="text-muted small">
                    <li><strong>Revoke</strong> - Permanently invalidate this certificate</li>
                    <li><strong>Certificate Hold</strong> - Temporary revocation (reversible)</li>
                </ul>
                <p class="text-muted small">
                    Only certificates revoked with "Certificate Hold" reason can be unrevoked.
                </p>

                {% if cert.source == 'external' %}
                <div class="alert alert-info small mt-3 mb-0">
                    <i class="bi bi-info-circle"></i>
                    External certificates have their private keys managed outside this system.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Revoke Certificate Modal -->
<div class="modal fade" id="revokeModal" tabindex="-1" aria-labelledby="revokeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="revokeModalLabel">
                    <i class="bi bi-shield-x"></i> Revoke Certificate
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Warning:</strong> This will revoke the certificate and add it to the CRL.
                    Only certificates with reason "certificateHold" can be unrevoked.
                </div>
                <div class="mb-3">
                    <label for="revocationReason" class="form-label">Revocation Reason</label>
                    <select class="form-select" id="revocationReason" required>
                        <option value="unspecified">Unspecified</option>
                        <option value="keyCompromise">Key Compromise</option>
                        <option value="cACompromise">CA Compromise</option>
                        <option value="affiliationChanged">Affiliation Changed</option>
                        <option value="superseded">Superseded</option>
                        <option value="cessationOfOperation">Cessation of Operation</option>
                        <option value="certificateHold">Certificate Hold (Reversible)</option>
                        <option value="removeFromCRL">Remove from CRL</option>
                        <option value="privilegeWithdrawn">Privilege Withdrawn</option>
                        <option value="aACompromise">AA Compromise</option>
                    </select>
                    <div class="form-text">
                        Select "Certificate Hold" if this revocation might be temporary.
                    </div>
                </div>
                <div class="mb-3">
                    <label for="revokeCAPassword" class="form-label">Issuing CA Password</label>
                    <input type="password" class="form-control" id="revokeCAPassword" required
                           placeholder="Enter password for {{ ca_id }}">
                    <div class="form-text">
                        Password is required to sign the updated CRL.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="revokeCertificate()">
                    <i class="bi bi-shield-x"></i> Revoke Certificate
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Unrevoke Certificate Modal -->
<div class="modal fade" id="unrevokeModal" tabindex="-1" aria-labelledby="unrevokeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="unrevokeModalLabel">
                    <i class="bi bi-shield-check"></i> Remove Certificate Hold
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    This will remove the certificate from the CRL and restore it to active status.
                </div>
                <div class="mb-3">
                    <label for="unrevokeCAPassword" class="form-label">Issuing CA Password</label>
                    <input type="password" class="form-control" id="unrevokeCAPassword" required
                           placeholder="Enter password for {{ ca_id }}">
                    <div class="form-text">
                        Password is required to sign the updated CRL.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="unrevokeCertificate()">
                    <i class="bi bi-shield-check"></i> Remove Hold
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/crl.js"></script>
<script>
// Set certificate ID for CRL functions
window.certId = '{{ cert.id }}';
window.caId = '{{ ca_id }}';

function copyActiveTabContent() {
    // Determine which tab is active
    const activeTab = document.querySelector('#certTabs .nav-link.active');
    let content = '';

    if (activeTab.id === 'text-tab') {
        content = document.getElementById('certTextContent').textContent;
    } else if (activeTab.id === 'pem-tab') {
        content = document.getElementById('certPemContent').textContent;
    }

    navigator.clipboard.writeText(content);
    showSuccess('Certificate content copied!');
}

function confirmKeyDownload(event, href) {
    event.preventDefault();
    showConfirm('Warning: This downloads the private key!\n\nOnly for authorized personnel!', {
        title: 'Download Private Key',
        confirmText: 'Download',
        confirmClass: 'btn-warning'
    }).then(confirmed => {
        if (confirmed) {
            window.location.href = href;
        }
    });
    return false;
}

function showRevokeModal() {
    const modal = new bootstrap.Modal(document.getElementById('revokeModal'));
    modal.show();
}

function showUnrevokeModal() {
    const modal = new bootstrap.Modal(document.getElementById('unrevokeModal'));
    modal.show();
}

async function revokeCertificate() {
    const reason = document.getElementById('revocationReason').value;
    const caPassword = document.getElementById('revokeCAPassword').value;

    if (!caPassword) {
        showError('CA password is required');
        return;
    }

    try {
        const response = await fetch(`/api/certs/${window.certId}/revoke`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                reason: reason,
                ca_password: caPassword
            })
        });

        if (response.ok) {
            showSuccess('Certificate revoked successfully');
            setTimeout(() => location.reload(), 1000);
        } else {
            const error = await response.json();
            showError('Error revoking certificate: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        showError('Error revoking certificate: ' + error.message);
    }

    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('revokeModal'));
    modal.hide();
}

async function unrevokeCertificate() {
    const caPassword = document.getElementById('unrevokeCAPassword').value;

    if (!caPassword) {
        showError('CA password is required');
        return;
    }

    try {
        const response = await fetch(`/api/certs/${window.certId}/unrevoke`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                ca_password: caPassword
            })
        });

        if (response.ok) {
            showSuccess('Certificate hold removed successfully');
            setTimeout(() => location.reload(), 1000);
        } else {
            const error = await response.json();
            showError('Error removing hold: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        showError('Error removing hold: ' + error.message);
    }

    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('unrevokeModal'));
    modal.hide();
}

async function confirmDelete() {
    const confirmed = await showConfirm('Move certificate "{{ cert.subject.common_name }}" to trash?', {
        title: 'Move to Trash',
        confirmText: 'Move to Trash',
        confirmClass: 'btn-danger'
    });

    if (confirmed) {
        try {
            const response = await fetch(`/api/certs/{{ cert.id }}`, { method: 'DELETE' });
            if (response.ok) {
                window.location.href = '/certs';
            } else {
                showError('Error moving to trash!');
            }
        } catch (error) {
            showError('Error moving to trash: ' + error.message);
        }
    }
}
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Import Certificate - HomeLab PKI{% endblock %}

{% block extra_head %}
<style>
.cert-preview {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    padding: 1rem;
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    max-height: 300px;
    overflow-y: auto;
    color: #212529;
}

[data-bs-theme="dark"] .cert-preview {
    background-color: #2b3035;
    border-color: #495057;
    color: #dee2e6;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <h1><i class="bi bi-upload"></i> Import External Certificate</h1>
        <p class="text-muted">Import an already-signed certificate for tracking purposes</p>

        <form id="importForm" class="needs-validation" novalidate>
            <!-- Issuing CA -->
            <div class="card mb-3">
                <div class="card-header">Issuing CA</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="issuingCa" class="form-label">Issuing CA *</label>
                        <select class="form-select" id="issuingCa" name="issuing_ca_id" required>
                            <option value="">-- Select a CA --</option>
                            {% for ca in available_cas %}
                            <option value="{{ ca.id }}" {% if ca.id == selected_ca_id %}selected{% endif %}>
                                {{ ca.subject.common_name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Choose the CA that signed this certificate (for organization purposes)</div>
                        <div class="invalid-feedback">Please select an issuing CA.</div>
                    </div>
                </div>
            </div>

            <!-- Certificate Upload -->
            <div class="card mb-3">
                <div class="card-header">Certificate Content</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="certFile" class="form-label">Upload Certificate File *</label>
                        <input type="file" class="form-control" id="certFile" accept=".crt,.pem,.cer" required>
                        <div class="form-text">Upload a PEM-encoded certificate (.crt, .pem, or .cer file)</div>
                        <div class="invalid-feedback">Please upload a valid certificate file.</div>
                    </div>

                    <div class="mb-3" id="certPreviewContainer" style="display: none;">
                        <label class="form-label">Certificate Preview:</label>
                        <div class="cert-preview" id="certPreview"></div>
                    </div>

                    <div id="certInfoContainer" style="display: none;">
                        <hr>
                        <h6>Extracted Certificate Information:</h6>
                        <table class="table table-sm">
                            <tbody id="certInfoTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Certificate Name -->
            <div class="card mb-3">
                <div class="card-header">Certificate Identifier</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="certName" class="form-label">Certificate Name *</label>
                        <input type="text" class="form-control" id="certName" name="cert_name" required
                               placeholder="e.g. imported-example-cert" pattern="^[a-zA-Z0-9-_]+$">
                        <div class="form-text">Unique identifier for this certificate (alphanumeric, hyphens, underscores)</div>
                        <div class="invalid-feedback">Please enter a valid certificate name (alphanumeric, hyphens, underscores only).</div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                    <i class="bi bi-upload"></i> Import Certificate
                </button>
                <a href="/certs" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>

    <!-- Info Panel -->
    <div class="col-lg-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> About Import
            </div>
            <div class="card-body">
                <p><strong>What is certificate import?</strong></p>
                <p class="text-muted small">
                    Importing allows you to track certificates that were signed externally
                    (by a different CA or system) within this management interface.
                </p>

                <hr>

                <p><strong>Prerequisites:</strong></p>
                <div class="alert alert-warning small">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i>
                    <strong>Important:</strong> Before importing a certificate, you must first import its issuing CA (and any other CAs in the chain) into this system.
                </div>
                <p class="text-muted small">
                    This ensures that the certificate can be correctly organized and its trust chain can be verified.
                </p>

                <hr>

                <p><strong>What gets stored?</strong></p>
                <ul class="text-muted small">
                    <li>Certificate file (.crt)</li>
                    <li>Certificate metadata</li>
                    <li>Subject and SANs information</li>
                </ul>

                <hr>

                <p><strong>What does NOT get stored?</strong></p>
                <ul class="text-muted small">
                    <li>Private key (managed externally)</li>
                    <li>CSR file (not needed for import)</li>
                </ul>

                <div class="alert alert-info mt-3">
                    <small>
                        <i class="bi bi-shield-lock"></i>
                        Imported certificates are marked as "External" to indicate
                        that the private key is not managed by this system.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let certContent = '';

// File upload handler
document.getElementById('certFile').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) {
        certContent = '';
        document.getElementById('certPreviewContainer').style.display = 'none';
        document.getElementById('certInfoContainer').style.display = 'none';
        document.getElementById('submitBtn').disabled = true;
        return;
    }

    try {
        certContent = await file.text();

        // Show certificate preview
        document.getElementById('certPreview').textContent = certContent;
        document.getElementById('certPreviewContainer').style.display = 'block';

        // Parse certificate to show information
        displayCertInfo(certContent);

        // Auto-populate cert name from filename (without extension)
        const fileName = file.name.replace(/\.(crt|pem|cer)$/i, '');
        const certNameInput = document.getElementById('certName');
        if (!certNameInput.value) {
            certNameInput.value = fileName.toLowerCase().replace(/[^a-z0-9-]/g, '-');
        }

        document.getElementById('submitBtn').disabled = false;
    } catch (error) {
        alert(`Error reading file: ${error.message}`);
        certContent = '';
        document.getElementById('submitBtn').disabled = true;
    }
});

function displayCertInfo(certContent) {
    const container = document.getElementById('certInfoContainer');
    const table = document.getElementById('certInfoTable');

    // Check if it's a valid PEM certificate
    const isPEM = certContent.includes('-----BEGIN CERTIFICATE-----') &&
                  certContent.includes('-----END CERTIFICATE-----');

    if (isPEM) {
        table.innerHTML = `
            <tr>
                <th width="30%">Format</th>
                <td><span class="badge bg-success">Valid PEM Certificate</span></td>
            </tr>
            <tr>
                <th>Type</th>
                <td><span class="badge bg-warning">External</span> (Private key not managed)</td>
            </tr>
            <tr>
                <th>Note</th>
                <td class="text-muted">Certificate details will be extracted upon import</td>
            </tr>
        `;
    } else {
        table.innerHTML = `
            <tr>
                <th width="30%">Format</th>
                <td><span class="badge bg-warning">Unknown format</span></td>
            </tr>
            <tr>
                <th>Note</th>
                <td class="text-muted">File should be PEM-encoded (-----BEGIN CERTIFICATE-----)</td>
            </tr>
        `;
    }

    container.style.display = 'block';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Form submission
document.getElementById('importForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    e.stopPropagation();

    if (!this.checkValidity()) {
        this.classList.add('was-validated');
        return;
    }

    if (!certContent) {
        alert('Please upload a certificate file');
        return;
    }

    const formData = new FormData(this);

    const request = {
        issuing_ca_id: formData.get('issuing_ca_id'),
        cert_content: certContent,
        cert_name: formData.get('cert_name')
    };

    try {
        const response = await fetch('/api/certs/import', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(request)
        });

        if (response.ok) {
            const result = await response.json();
            window.location.href = `/certs/${result.id}`;
        } else {
            const error = await response.json();
            alert(`Error: ${error.detail}`);
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
});
</script>
{% endblock %}

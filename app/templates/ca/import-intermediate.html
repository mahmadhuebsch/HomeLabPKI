{% extends "base.html" %}

{% block title %}Import Intermediate CA - HomeLab PKI{% endblock %}

{% block extra_head %}
<style>
.cert-preview {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    padding: 1rem;
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    max-height: 300px;
    overflow-y: auto;
    color: #212529;
}

[data-bs-theme="dark"] .cert-preview {
    background-color: #2b3035;
    border-color: #495057;
    color: #dee2e6;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <h1><i class="bi bi-upload"></i> Import Intermediate CA</h1>
        <p class="text-muted">Import an external Intermediate CA certificate</p>

        <form id="importForm" class="needs-validation" novalidate>
            <!-- Parent CA Selection -->
            <div class="card mb-3">
                <div class="card-header">Parent CA *</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="parentCa" class="form-label">Select Parent CA</label>
                        <select class="form-select" id="parentCa" name="parent_ca_id" required>
                            <option value="">-- Select the issuing CA --</option>
                            {% for ca in root_cas %}
                            <option value="{{ ca.id }}" {% if preselected_parent == ca.id %}selected{% endif %}>
                                {{ ca.subject.common_name }} (Root)
                            </option>
                            {% endfor %}
                            {% for ca in intermediate_cas %}
                            <option value="{{ ca.id }}" {% if preselected_parent == ca.id %}selected{% endif %}>
                                {{ ca.subject.common_name }} (Intermediate)
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Select the CA that issued this intermediate certificate.</div>
                        <div class="invalid-feedback">Please select a parent CA.</div>
                    </div>
                </div>
            </div>

            <!-- Certificate Upload -->
            <div class="card mb-3">
                <div class="card-header">Certificate Content</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="certFile" class="form-label">Upload Certificate File *</label>
                        <input type="file" class="form-control" id="certFile" accept=".crt,.pem,.cer" required>
                        <div class="form-text">Upload a single PEM-encoded intermediate CA certificate (.crt, .pem, or .cer).</div>
                        <div class="invalid-feedback">Please upload a valid certificate file.</div>
                    </div>

                    <div class="mb-3" id="certPreviewContainer" style="display: none;">
                        <label class="form-label">Certificate Preview:</label>
                        <div class="cert-preview" id="certPreview"></div>
                    </div>

                    <div id="certInfoContainer" style="display: none;">
                        <hr>
                        <h6>Certificate Information:</h6>
                        <table class="table table-sm">
                            <tbody id="certInfoTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- CA Name -->
            <div class="card mb-3">
                <div class="card-header">CA Identifier</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="caName" class="form-label">CA Name *</label>
                        <input type="text" class="form-control" id="caName" name="ca_name" required
                               placeholder="e.g. corp-intermediate" pattern="^[a-zA-Z0-9-_]+$">
                        <div class="form-text">Unique identifier for this CA (alphanumeric, hyphens, underscores).</div>
                        <div class="invalid-feedback">Please enter a valid CA name.</div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                    <i class="bi bi-upload"></i> Import CA
                </button>
                <a href="/intermediates" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>

    <!-- Info Panel -->
    <div class="col-lg-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> About Intermediate CA Import
            </div>
            <div class="card-body">
                <p><strong>What can I import?</strong></p>
                <p class="text-muted small">
                    Import an Intermediate CA certificate that was issued by a CA already in this system.
                </p>

                <hr>

                <p><strong>Prerequisites</strong></p>
                <p class="text-muted small">
                    The parent CA (issuer) must already exist in the system. Import in order:
                </p>
                <ol class="text-muted small">
                    <li>Root CA (via <a href="/rootcas/import">Import Root CA</a>)</li>
                    <li>Then import intermediate CAs here</li>
                </ol>

                <hr>

                <p><strong>File Format</strong></p>
                <p class="text-muted small">
                    Upload a single PEM-encoded certificate file. The certificate must have CA:TRUE in its Basic Constraints extension.
                </p>

                <div class="alert alert-warning small mt-3">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    <strong>Note:</strong> Self-signed (Root) certificates must be imported via the Root CA Import page.
                </div>

                <hr>

                <p><strong>What gets stored?</strong></p>
                <ul class="text-muted small">
                    <li>The CA certificate</li>
                    <li>Certificate metadata</li>
                </ul>

                <div class="alert alert-info small mt-3">
                    <i class="bi bi-shield-lock me-1"></i>
                    Imported CAs are marked as <span class="badge bg-warning text-dark">External</span> to indicate the private key is not managed by this system.
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let certContent = '';

// File upload handler
document.getElementById('certFile').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) {
        certContent = '';
        document.getElementById('certPreviewContainer').style.display = 'none';
        document.getElementById('certInfoContainer').style.display = 'none';
        updateSubmitButton();
        return;
    }

    try {
        certContent = await file.text();

        // Show certificate preview
        document.getElementById('certPreview').textContent = certContent;
        document.getElementById('certPreviewContainer').style.display = 'block';

        // Parse certificate to show information
        displayCertInfo(certContent);

        // Auto-populate cert name from filename (without extension)
        const fileName = file.name.replace(/\.(crt|pem|cer)$/i, '');
        const caNameInput = document.getElementById('caName');
        if (!caNameInput.value) {
            caNameInput.value = fileName.toLowerCase().replace(/[^a-z0-9-]/g, '-');
        }

        updateSubmitButton();
    } catch (error) {
        showError('Error reading file: ' + error.message);
        certContent = '';
        updateSubmitButton();
    }
});

// Parent CA selection handler
document.getElementById('parentCa').addEventListener('change', updateSubmitButton);

function updateSubmitButton() {
    const parentCaSelected = document.getElementById('parentCa').value !== '';
    const hasContent = certContent !== '';
    document.getElementById('submitBtn').disabled = !(parentCaSelected && hasContent);
}

function displayCertInfo(certContent) {
    const container = document.getElementById('certInfoContainer');
    const table = document.getElementById('certInfoTable');

    const certCount = (certContent.match(/-----BEGIN CERTIFICATE-----/g) || []).length;

    if (certCount === 1) {
        table.innerHTML = `
            <tr>
                <th width="30%">Format</th>
                <td><span class="badge bg-success">Valid PEM</span></td>
            </tr>
            <tr>
                <th>Certificates</th>
                <td><span class="badge bg-info">1</span></td>
            </tr>
        `;
    } else if (certCount > 1) {
        table.innerHTML = `
            <tr>
                <th width="30%">Format</th>
                <td><span class="badge bg-warning">Multiple Certificates</span></td>
            </tr>
            <tr>
                <th>Certificates</th>
                <td><span class="badge bg-warning">${certCount}</span></td>
            </tr>
            <tr>
                <th>Warning</th>
                <td class="text-warning">Please provide only a single certificate.</td>
            </tr>
        `;
    } else {
        table.innerHTML = `
            <tr>
                <th width="30%">Format</th>
                <td><span class="badge bg-danger">Invalid PEM format</span></td>
            </tr>
            <tr>
                <th>Note</th>
                <td class="text-muted">File should contain a PEM-encoded certificate.</td>
            </tr>
        `;
    }
    container.style.display = 'block';
}

// Form submission
document.getElementById('importForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    e.stopPropagation();

    if (!this.checkValidity()) {
        this.classList.add('was-validated');
        return;
    }

    if (!certContent) {
        showWarning('Please upload a certificate file');
        return;
    }

    const formData = new FormData(this);
    const parentCaId = formData.get('parent_ca_id');

    if (!parentCaId) {
        showWarning('Please select a parent CA');
        return;
    }

    const request = {
        ca_cert_content: certContent,
        ca_name: formData.get('ca_name'),
        parent_ca_id: parentCaId
    };

    try {
        const response = await fetch('/api/cas/import-intermediate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(request)
        });

        if (response.ok) {
            const result = await response.json();
            window.location.href = `/intermediates/${result.id}`;
        } else {
            const error = await response.json();
            let errorMsg = error.detail;
            if (Array.isArray(error.detail)) {
                errorMsg = error.detail.map(e => e.msg || e.message || JSON.stringify(e)).join(', ');
            } else if (typeof error.detail === 'object') {
                errorMsg = JSON.stringify(error.detail);
            }
            showError(errorMsg || 'Failed to import intermediate CA');
        }
    } catch (error) {
        showError(error.message || 'An unexpected error occurred');
    }
});
</script>
{% endblock %}

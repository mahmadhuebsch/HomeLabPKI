{% extends "base.html" %}

{% block title %}{{ ca.subject.common_name }} - HomeLab PKI{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="row mb-3">
            <div class="col">
                <a href="/rootcas" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-8">
                <h1>{{ ca.subject.common_name }}</h1>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-danger" onclick="confirmDelete()">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </div>
        </div>

<!-- Certificate Information -->
<div class="card mb-4">
    <div class="card-header">Certificate Information</div>
    <div class="card-body">
        <!-- Certificate Chain Breadcrumb (only show for intermediate CAs with chain > 1) -->
        {% if cert_chain and cert_chain|length > 1 %}
        <nav aria-label="Certificate Chain" class="mb-3">
            <ol class="breadcrumb mb-0">
                {% for chain_ca in cert_chain %}
                    {% if loop.last %}
                    <li class="breadcrumb-item active" aria-current="page">
                        {% if chain_ca.type == 'root' %}
                        <i class="bi bi-shield-lock text-primary"></i>
                        {% else %}
                        <i class="bi bi-diagram-3 text-info"></i>
                        {% endif %}
                        {{ chain_ca.name }}
                    </li>
                    {% else %}
                    <li class="breadcrumb-item">
                        <a href="{{ chain_ca.url }}">
                            {% if chain_ca.type == 'root' %}
                            <i class="bi bi-shield-lock text-primary"></i>
                            {% else %}
                            <i class="bi bi-diagram-3 text-info"></i>
                            {% endif %}
                            {{ chain_ca.name }}
                        </a>
                    </li>
                    {% endif %}
                {% endfor %}
            </ol>
        </nav>
        <hr>
        {% endif %}

        <table class="table table-borderless">
            <tr>
                <th>Subject:</th>
                <td>
                    {% if ca.subject.common_name %}CN={{ ca.subject.common_name }}{% endif %}
                    {% if ca.subject.organization %}, O={{ ca.subject.organization }}{% endif %}
                    {% if ca.subject.organizational_unit %}, OU={{ ca.subject.organizational_unit }}{% endif %}
                    {% if ca.subject.country %}, C={{ ca.subject.country }}{% endif %}
                    {% if ca.subject.state %}, ST={{ ca.subject.state }}{% endif %}
                    {% if ca.subject.locality %}, L={{ ca.subject.locality }}{% endif %}
                </td>
            </tr>
            <tr>
                <th>Validity:</th>
                <td>
                    {{ ca.not_before.strftime('%d.%m.%Y %H:%M') }} - {{ ca.not_after.strftime('%d.%m.%Y %H:%M') }}
                    <span class="badge bg-{{ ca.validity_status }}">{{ ca.validity_text }}</span>
                </td>
            </tr>
            <tr>
                <th>Fingerprint (SHA256):</th>
                <td><code>{{ ca.fingerprint_sha256 }}</code></td>
            </tr>
            <tr>
                <th>Type:</th>
                <td>{{ 'Root CA' if ca.type.value == 'root_ca' else 'Intermediate CA' }}</td>
            </tr>
            <tr>
                <th>Key Usage:</th>
                <td>
                    {% if ca.key_usage %}
                        {% for ku in ca.key_usage %}
                            <span class="badge bg-info">{{ ku }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <th>Extended Key Usage:</th>
                <td>
                    {% if ca.extended_key_usage %}
                        {% for eku in ca.extended_key_usage %}
                            <span class="badge bg-success">{{ eku }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
            </tr>
        </table>
    </div>
</div>

<!-- Downloads -->
<div class="card mb-4">
    <div class="card-header">Downloads</div>
    <div class="card-body">
        <a href="/download/ca/{{ ca.id }}/cert" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-download"></i> Certificate (.crt)
        </a>
        <a href="/download/ca/{{ ca.id }}/key" class="btn btn-sm btn-outline-warning"
           onclick="return confirmKeyDownload(event, this.href)">
            <i class="bi bi-download"></i> Private Key (.key)
        </a>
    </div>
</div>

<!-- CRL Management -->
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <span><i class="bi bi-shield-x"></i> CRL Management</span>
            <button class="btn btn-sm btn-outline-primary" onclick="showRegenerateCRLModal()">
                <i class="bi bi-arrow-clockwise"></i> Regenerate CRL
            </button>
        </div>
    </div>
    <div class="card-body">
        {% if crl_info %}
        <table class="table table-borderless">
            <tr>
                <th>CRL Number:</th>
                <td>{{ crl_info.crl_number }}</td>
            </tr>
            <tr>
                <th>Last Updated:</th>
                <td>{{ crl_info.last_updated.strftime('%d.%m.%Y %H:%M') if crl_info.last_updated else 'Never' }}</td>
            </tr>
            <tr>
                <th>Next Update:</th>
                <td>
                    {{ crl_info.next_update.strftime('%d.%m.%Y %H:%M') }}
                    {% if crl_info.next_update < now %}
                    <span class="badge bg-danger">Expired</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <th>Revoked Certificates:</th>
                <td>{{ crl_info.revoked_count }}</td>
            </tr>
        </table>

        <div class="btn-group" role="group">
            <a href="/download/ca/{{ ca.id }}/crl" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-download"></i> CRL (PEM)
            </a>
            <a href="/download/ca/{{ ca.id }}/crl/der" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-download"></i> CRL (DER)
            </a>
        </div>

        {% if revoked_certs %}
        <hr>
        <h6>Revoked Certificates</h6>
        <div class="list-group">
            {% for entry in revoked_certs %}
            <div class="list-group-item">
                <div class="d-flex w-100 justify-content-between">
                    <span>{{ entry.common_name or entry.serial_number }}</span>
                    <small class="text-muted">{{ entry.revoked_at.strftime('%d.%m.%Y') }}</small>
                </div>
                <small class="text-muted">
                    Serial: {{ entry.serial_number }} | Reason: {{ entry.reason }}
                </small>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% else %}
        <p class="text-muted">No CRL generated yet. Click "Regenerate CRL" to create one.</p>
        {% endif %}
    </div>
</div>

<!-- Regenerate CRL Modal -->
<div class="modal fade" id="regenerateCRLModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Regenerate CRL</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>This will regenerate the Certificate Revocation List for this CA.</p>
                <div class="mb-3">
                    <label class="form-label">CA Password</label>
                    <input type="password" class="form-control" id="crlCaPassword" required>
                    <small class="form-text text-muted">Required to sign the CRL</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="regenerateCRL()">Regenerate</button>
            </div>
        </div>
    </div>
</div>

<!-- CA Certificate Content -->
<div class="accordion" id="certContentAccordion">
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingOne">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCertContent" aria-expanded="false" aria-controls="collapseCertContent">
                CA Certificate Details
            </button>
        </h2>
        <div id="collapseCertContent" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#certContentAccordion">
            <div class="accordion-body">
                <div class="d-flex justify-content-end mb-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="copyActiveTabContent()">
                        <i class="bi bi-clipboard"></i> Copy
                    </button>
                </div>
                <ul class="nav nav-tabs" id="certTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="text-tab" data-bs-toggle="tab" data-bs-target="#text-content" type="button" role="tab">
                            Text Format
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pem-tab" data-bs-toggle="tab" data-bs-target="#pem-content" type="button" role="tab">
                            PEM Format
                        </button>
                    </li>
                </ul>
                <div class="tab-content" id="certTabContent">
                    <div class="tab-pane fade show active" id="text-content" role="tabpanel">
                        <pre id="certTextContent" class="code-block">{{ ca_cert_text }}</pre>
                    </div>
                    <div class="tab-pane fade" id="pem-content" role="tabpanel">
                        <pre id="certPemContent" class="code-block">{{ ca_cert_content }}</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Intermediate CAs (only shown for Root CAs) -->
{% if ca.type.value == 'root_ca' or ca.type.value == 'intermediate_ca' %}
<div class="card my-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <span>Intermediate CAs ({{ intermediate_cas|length }})</span>
            <a href="/intermediates/create?parent_ca_id={{ ca.id }}" class="btn btn-sm btn-primary">
                <i class="bi bi-plus-circle"></i> New Intermediate CA
            </a>
        </div>
    </div>
    <div class="card-body">
        {% if intermediate_cas %}
            <div class="list-group">
                {% for int_ca in intermediate_cas %}
                <a href="/intermediates/{{ int_ca.id }}" class="list-group-item list-group-item-action">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">
                            <i class="bi bi-diagram-3 text-primary"></i>
                            {{ int_ca.subject.common_name }}
                        </h6>
                        <small>
                            <span class="badge bg-{{ int_ca.validity_status }}">{{ int_ca.validity_text }}</span>
                        </small>
                    </div>
                    <p class="mb-1 text-muted">
                        Valid until: {{ int_ca.not_after.strftime('%d.%m.%Y %H:%M') }} |
                        {{ int_ca.cert_count }} Certificate(s)
                    </p>
                </a>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-muted">No Intermediate CAs available.</p>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Certificates -->
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <span>Certificates ({{ certificates|length }})</span>
            <div class="btn-group" role="group">
                <a href="/certs/create?ca_id={{ ca.id }}" class="btn btn-sm btn-primary">
                    <i class="bi bi-plus-circle"></i> New Certificate
                </a>
                <a href="/certs/sign-csr?ca_id={{ ca.id }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-file-earmark-text"></i> Sign CSR
                </a>
                <a href="/certs/import?ca_id={{ ca.id }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-upload"></i> Import
                </a>
            </div>
        </div>
    </div>
    <div class="card-body">
        {% if certificates %}
            <div class="list-group">
                {% for cert in certificates %}
                <a href="/certs/{{ cert.id }}" class="list-group-item list-group-item-action">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">
                            <i class="bi bi-file-earmark-lock text-{{ cert.validity_status }}"></i>
                            {{ cert.subject.common_name }}
                            {% if cert.source == 'external' %}
                            <span class="badge bg-warning text-dark">External</span>
                            {% endif %}
                        </h6>
                        <small>
                            <span class="badge bg-{{ cert.validity_status }}">{{ cert.validity_text }}</span>
                        </small>
                    </div>
                    <p class="mb-1 text-muted">
                        Serial: {{ cert.serial_number }} | Valid until: {{ cert.not_after.strftime('%d.%m.%Y') }}
                    </p>
                    {% if cert.sans %}
                    <small>SANs: {{ cert.sans|join(', ') }}</small>
                    {% endif %}
                </a>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-muted">No certificates available.</p>
        {% endif %}
    </div>
</div>
    </div>

    <!-- Help Panel -->
    <div class="col-lg-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> CA Details
            </div>
            <div class="card-body">
                <p><strong>Certificate Information</strong></p>
                <p class="text-muted small">
                    This section displays the CA's subject, validity period, fingerprint,
                    and X.509 extensions. Key Usage shows what operations this CA can perform.
                </p>

                <hr>

                <p><strong>Downloads</strong></p>
                <ul class="text-muted small">
                    <li><strong>Certificate (.crt)</strong> - Public certificate for distribution</li>
                    <li><strong>Private Key (.key)</strong> - Keep secure, needed for signing</li>
                </ul>

                <hr>

                <p><strong>Hierarchy</strong></p>
                <p class="text-muted small">
                    {% if ca.type.value == 'root_ca' %}
                    This is a Root CA. It can sign Intermediate CAs and end-entity certificates directly.
                    Best practice is to use Intermediate CAs for day-to-day signing.
                    {% else %}
                    This is an Intermediate CA. It was signed by a parent CA and can sign
                    end-entity certificates or additional Intermediate CAs.
                    {% endif %}
                </p>

                <hr>

                <p><strong>CRL Management</strong></p>
                <p class="text-muted small">
                    Certificate Revocation Lists (CRLs) track revoked certificates per RFC 5280.
                    CRLs are automatically regenerated when certificates are revoked.
                </p>
                <ul class="text-muted small">
                    <li><strong>Public CRL URL (RFC 2585)</strong>:<br>
                        <code class="small">/download/crl/{{ ca.id }}.crl</code></li>
                    <li><strong>PEM Format</strong> - For OpenSSL tools</li>
                    <li><strong>DER Format</strong> - Standard format for clients</li>
                </ul>
                <p class="text-muted small">
                    <strong>Auto-embed CDP in certificates:</strong> Set <code>crl.base_url</code> in
                    <code>config.yaml</code> to automatically include the CRL Distribution Point
                    extension in new certificates.
                </p>

                <hr>

                <p><strong>Security Notes:</strong></p>
                <ul class="text-muted small mb-0">
                    <li>Keep private keys secure and encrypted</li>
                    <li>Use strong passwords for key protection</li>
                    <li>Monitor certificate expiration dates</li>
                    <li>Limit who has access to signing capabilities</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/crl.js"></script>
<script>
// Set CA ID for CRL functions
window.caId = '{{ ca.id }}';

function copyActiveTabContent() {
    // Determine which tab is active
    const activeTab = document.querySelector('#certTabs .nav-link.active');
    let content = '';

    if (activeTab.id === 'text-tab') {
        content = document.getElementById('certTextContent').textContent;
    } else if (activeTab.id === 'pem-tab') {
        content = document.getElementById('certPemContent').textContent;
    }

    navigator.clipboard.writeText(content);
    showSuccess('Certificate content copied!');
}

function confirmKeyDownload(event, href) {
    event.preventDefault();
    showConfirm('Warning: This downloads the private key!\n\nOnly for authorized personnel!', {
        title: 'Download Private Key',
        confirmText: 'Download',
        confirmClass: 'btn-warning'
    }).then(confirmed => {
        if (confirmed) {
            window.location.href = href;
        }
    });
    return false;
}

async function confirmDelete() {
    const confirmed = await showConfirm('Move CA "{{ ca.subject.common_name }}" to trash?\n\nThis will also move all Intermediate CAs and certificates to trash.', {
        title: 'Move to Trash',
        confirmText: 'Move to Trash',
        confirmClass: 'btn-danger'
    });

    if (confirmed) {
        try {
            const response = await fetch(`/api/cas/{{ ca.id }}`, { method: 'DELETE' });
            if (response.ok) {
                window.location.href = '/rootcas';
            } else {
                showError('Error moving to trash!');
            }
        } catch (error) {
            showError('Error moving to trash: ' + error.message);
        }
    }
}
</script>
{% endblock %}
